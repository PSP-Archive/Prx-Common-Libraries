#include <pspsdk.h>
#include <pspkernel.h>
#include <pspctrl.h>
#include <pspctrl_kernel.h>

#include "cmlibctrl.h"


PSP_MODULE_INFO("cmlibCtrl", PSP_MODULE_KERNEL, 1, 2);

int flag = 0;

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libctrlMaskAllButton
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

bool libctrlMaskAllButton()
{
	if(flag < 0)flag = 0;
	sceCtrl_driver_7CA723DC(0xFFFF, (flag > 0 ? 1 : 0));
	
	return (flag >0 ? true : false);

}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libctrlMaskAllButtonOn
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

int libctrlMaskAllButtonOn(bool *status)
{
	if(*status != true){
		*status = true;
		flag ++;
		libctrlMaskAllButton();
		return 0;
	}
	return -1;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libctrlMaskAllButtonOff
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

int libctrlMaskAllButtonOff(bool *status)
{
	if(*status == true){
		*status = false;
		flag --;
		libctrlMaskAllButton();
		return 0;
	}
	return -1;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libctrlMaskAllButtonStatus
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

bool libctrlMaskAllButtonStatus()
{
	return (flag >0 ? true : false);

}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libctrlMaskAllButtonAgain
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

bool libctrlMaskAllButtonAgain()
{
	return libctrlMaskAllButton();
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libctrlMaskButtonOn
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

int libctrlMaskButtonOn(int PspCtrlButtons)
{
	sceCtrl_driver_7CA723DC(PspCtrlButtons,1);
	return 0;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libctrlMaskButtonOff
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

int libctrlMaskButtonOff(int PspCtrlButtons)
{
	sceCtrl_driver_7CA723DC(PspCtrlButtons,0);
	return 0;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libctrlMaskButtonStatus
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

bool libctrlMaskButtonStatus(int PspCtrlButtons)
{
	int status = sceCtrl_driver_5E77BC8A(PspCtrlButtons);
	
	return (status == 1 ? true : false);
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libctrlCountButtons		Thanks plum
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

int libctrlCountButtons(u32 buttons, int count)
{
	SceCtrlData pad;
	clock_t time;

	// 指定するボタンをセット
	pad.Buttons = buttons;

	// 現在の時間 + 指定した時間
	count = 1000000 * count;		//count秒
	time = sceKernelLibcClock() + count;

	// ボタンが離れるまでループ
	while((pad.Buttons & buttons) == buttons)
	{
		// ディレイ
		sceKernelDelayThread(50000);

		// パッド情報を取得する
		sceCtrlPeekBufferPositive(&pad, 1);
		// 現在の時間が指定した時間を過ぎたら
		if(sceKernelLibcClock() > time)
			return 1;
	}

	return 0;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libctrlWaitButtonUp		Thanks SnyFbSx
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

int libctrlWaitButtonUp(u32 buttons)
{
	SceCtrlData pad;

	sceCtrlPeekBufferPositive( &pad, 1 );
	while( (pad.Buttons & buttons) != 0 ){
		sceCtrlPeekBufferPositive( &pad, 1 );
		sceKernelDelayThread( 50000 );
	}

	return 0;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  libctrlWaitButtonDown
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

int libctrlWaitButtonDown(u32 buttons)
{
	SceCtrlData pad;

	sceCtrlPeekBufferPositive( &pad, 1 );
	while( (pad.Buttons & buttons) != buttons ){
		sceCtrlPeekBufferPositive( &pad, 1 );
		sceKernelDelayThread( 50000 );
	}

	return 0;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  ENTRY POINT
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

int module_start(SceSize args, void *argp)
{
	return 0;
}

int module_stop(SceSize args, void *argp)
{
	return 0;
}
